<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание - Time Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            --card-bg: #ffffff;
            --text-color: #333;
            --primary-color: #6d5a8a;
            --gradient-primary: linear-gradient(135deg, #f8b5d1 0%, #ffafcc 100%);
            --gradient-secondary: linear-gradient(135deg, #cdb4db 0%, #bde0fe 100%);
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        /* Основные стили */
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .schedule-section {
            flex: 1;
            min-width: 0;
        }
        
        .right-sidebar {
            width: 350px;
            min-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Панель управления */
        .schedule-controls {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(248, 181, 209, 0.05);
            margin-bottom: 1rem;
            border: 1px solid rgba(248, 181, 209, 0.15);
        }
        
        /* Таблица расписания с раздельными колонками */
        .schedule-container {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
            overflow: hidden;
            overflow-x: auto;
            width: 100%;
            border: 1px solid rgba(248, 181, 209, 0.15);
        }
        
        .schedule-header {
            background: var(--gradient-primary);
            color: var(--text-color);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .schedule-table {
            min-width: 1200px;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .time-column {
            width: 80px;
            background-color: rgba(248, 181, 209, 0.05);
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            vertical-align: top;
            padding: 0.5rem;
            border-right: 1px solid rgba(248, 181, 209, 0.2);
            position: sticky;
            left: 0;
            z-index: 50;
        }
        
        .day-column {
            width: 100px;
            vertical-align: top;
            border-right: 1px solid rgba(248, 181, 209, 0.2);
            position: relative;
        }
        
        .day-header {
            background-color: rgba(248, 181, 209, 0.1);
            padding: 0.75rem;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid rgba(248, 181, 209, 0.3);
            position: sticky;
            top: 60px;
            z-index: 80;
            color: var(--text-color);
        }
        
        /* Ячейки План/Факт */
        .plan-column {
            background-color: rgba(167, 210, 203, 0.05); /* Мятный */
            border-bottom: 1px solid rgba(167, 210, 203, 0.1);
            height: 25px;
            padding: 0;
            position: relative;
            cursor: pointer;
            z-index: 1; 
        }
        
        .fact-column {
            background-color: rgba(205, 180, 219, 0.05); /* Лавандовый */
            border-bottom: 1px solid rgba(205, 180, 219, 0.1);
            height: 25px;
            padding: 0;
            position: relative;
            cursor: pointer;
            z-index: 1;
        }

        .plan-column:hover, .fact-column:hover {
            background-color: rgba(0,0,0,0.05); /* Легкая подсветка при наведении */
        }
        
        .plan-header {
            background-color: rgba(167, 210, 203, 0.2); /* Мятный 20% */
            color: #2d6a4f;
            padding: 0.4rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(167, 210, 203, 0.3);
            position: sticky;
            top: 105px;
            z-index: 70;
        }
        
        .fact-header {
            background-color: rgba(205, 180, 219, 0.2); /* Лавандовый 20% */
            color: #6d5a8a;
            padding: 0.4rem;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(205, 180, 219, 0.3);
            position: sticky;
            top: 105px;
            z-index: 70;
        }
    
        /* События */
        .plan-event, .fact-event {
            position: absolute;
            left: 1px;
            right: 1px;
            border-radius: 3px;
            padding: 1px 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            border-left: 3px solid;
            z-index: 10;
            line-height: 1.2;
            pointer-events: auto;
        }
        
        .plan-event {
            background-color: rgba(167, 210, 203, 0.9);
            border-color: #2d6a4f;
            color: #1a4131;
        }
        
        .fact-event {
            background-color: rgba(205, 180, 219, 0.9);
            border-color: #6d5a8a;
            color: #4a3b5f;
        }
        
        /* Выделение ячеек */
        .plan-column.selected {
            background-color: rgba(167, 210, 203, 0.4) !important;
            box-shadow: inset 0 0 0 2px #2d6a4f;
        }
        
        .fact-column.selected {
            background-color: rgba(205, 180, 219, 0.4) !important;
            box-shadow: inset 0 0 0 2px #6d5a8a;
        }
        
        /* Текущее время */
        .current-time-slot {
            background-color: rgba(255, 209, 102, 0.15);
            position: relative;
        }
        
        .current-time-slot::after {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 2px;
            background-color: #ffd166;
            z-index: 5;
            pointer-events: none;
        }
        
        /* Панель массового заполнения */
        .bulk-edit-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(248, 181, 209, 0.15);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(248, 181, 209, 0.2);
        }
        
        .bulk-edit-panel.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Правая панель */
        .categories-panel, .productivity-chart, .balance-wheel-container, .quick-actions {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
            border: 1px solid rgba(248, 181, 209, 0.15);
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: rgba(248, 181, 209, 0.05);
            border-left: 4px solid;
            transition: all 0.2s;
        }
        
        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Actions */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 1rem;
        }
        
        .action-btn {
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid rgba(248, 181, 209, 0.3);
            background: rgba(248, 181, 209, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            text-align: center;
        }
        
        .action-btn:hover {
            background: rgba(248, 181, 209, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(248, 181, 209, 0.2);
            border-color: var(--primary-color);
        }
        
        .action-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        /* Адаптивность */
        @media (max-width: 1200px) {
            .main-content { flex-direction: column; }
            .right-sidebar { width: 100%; min-width: auto; }
            .schedule-container { min-width: 100%; }
        }
    </style>
</head>
<body>

<div class="fade-in">
    <div class="schedule-controls">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h4 class="mb-0">Расписание</h4>
                <small class="text-muted">Шаг 15 минут</small>
            </div>
            
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-success" id="addPlanBtn">
                        <i class="bi bi-plus-circle me-1"></i>Добавить план
                    </button>
                    <button class="btn btn-outline-primary" id="addFactBtn">
                        <i class="bi bi-plus-circle me-1"></i>Добавить факт
                    </button>
                </div>
                
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text"><i class="bi bi-calendar-week"></i></span>
                    <input type="week" class="form-control" id="weekPicker">
                    <button class="btn btn-outline-secondary" type="button" id="prevWeekBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="nextWeekBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="currentWeekBtn">
                        Сегодня
                    </button>
                </div>
                
                <button class="btn btn-outline-success" id="saveTemplateBtn">
                    <i class="bi bi-save me-1"></i>Сохранить шаблон
                </button>
                
                <button class="btn btn-primary" id="templatesBtn">
                    <i class="bi bi-collection me-1"></i>Шаблоны
                </button>
            </div>
        </div>
    </div>
    
    <div class="bulk-edit-panel" id="bulkEditPanel">
        <div class="selected-count" id="selectedCount">0 ячеек выбрано</div>
        <select class="form-select form-select-sm" id="bulkCategorySelect" style="width: 180px;">
            <option value="">Выберите категорию</option>
        </select>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" id="bulkPlanBtn">Заполнить: План</button>
            <button class="btn btn-primary" id="bulkFactBtn">Заполнить: Факт</button>
            <button class="btn btn-secondary" id="bulkClearBtn">Очистить</button>
        </div>
        <button class="btn btn-outline-danger btn-sm" id="bulkCancelBtn">Отмена</button>
    </div>
    
    <div class="main-content">
        <div class="schedule-section">
            <div class="schedule-container">
                <div class="schedule-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Недельное расписание</h5>
                            <small id="weekRange"></small>
                        </div>
                        <div class="text-end">
                            <small class="d-block"><span class="badge bg-success">План</span> <span class="badge bg-primary">Факт</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="schedule-table" id="scheduleTable">
                        <thead id="scheduleHeader">
                            </thead>
                        <tbody id="scheduleBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="right-sidebar">
            <div class="categories-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Категории</h5>
                    <button class="btn btn-sm btn-primary" id="addCategoryBtn"><i class="bi bi-plus"></i></button>
                </div>
                <div class="categories-list" id="categoriesList"></div>
            </div>
            
            <div class="balance-wheel-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Колесо баланса</h5>
                    <select class="form-select form-select-sm wheel-period-selector" style="width: 150px;" id="wheelPeriod">
                        <option value="day">Текущий день</option>
                        <option value="week" selected>Текущая неделя</option>
                    </select>
                </div>
                <div class="wheel-canvas">
                    <canvas id="balanceWheel" width="250" height="250"></canvas>
                </div>
                <div class="wheel-legend" id="wheelLegend"></div>
            </div>
            
            <div class="quick-actions">
                <h5>Быстрые действия</h5>
                <div class="actions-grid">
                    <div class="action-btn" id="quickEventBtn">
                        <i class="bi bi-plus-circle action-icon"></i>
                        <span class="action-text">Новое событие</span>
                    </div>
                    <div class="action-btn" id="copyDayBtn">
                        <i class="bi bi-files action-icon"></i>
                        <span class="action-text">Копия дня</span>
                    </div>
                    <div class="action-btn" id="clearDayBtn">
                        <i class="bi bi-trash action-icon"></i>
                        <span class="action-text">Очистить день</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить событие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEventForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Тип события</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="eventType" id="typePlan" value="plan" checked>
                                <label class="btn btn-outline-success" for="typePlan">План</label>
                                <input type="radio" class="btn-check" name="eventType" id="typeFact" value="fact">
                                <label class="btn btn-outline-primary" for="typeFact">Факт</label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="categorySelect" class="form-label">Категория</label>
                            <select class="form-select" id="categorySelect" required></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">Дата начала</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Время начала</label>
                            <select class="form-select" id="startTime" required></select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">Дата окончания</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">Время окончания</label>
                            <select class="form-select" id="endTime" required></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="eventDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новая категория</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Название</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Цвет</label>
                        <div class="d-flex flex-wrap gap-2" id="colorPicker"></div>
                        <input type="hidden" id="selectedColor" value="#4361ee">
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="quickEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Быстрое событие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickEventForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Категория</label>
                        <select class="form-select" id="quickCategory" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Тип</label>
                        <select class="form-select" id="quickType">
                            <option value="plan">План</option>
                            <option value="fact">Факт</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Длительность</label>
                        <select class="form-select" id="quickDuration">
                            <option value="15">15 минут</option>
                            <option value="30">30 минут</option>
                            <option value="60" selected>1 час</option>
                            <option value="120">2 часа</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="quick-add-buttons mt-3 text-center">
    <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-success" id="quickBreakfastBtn"><i class="bi bi-cup-hot"></i> Завтрак</button>
        <button class="btn btn-outline-primary" id="quickWorkBtn"><i class="bi bi-briefcase"></i> Работа</button>
        <button class="btn btn-outline-warning" id="quickSportBtn"><i class="bi bi-heart-pulse"></i> Спорт</button>
        <button class="btn btn-outline-info" id="quickStudyBtn"><i class="bi bi-book"></i> Учёба</button>
        <button class="btn btn-outline-secondary" id="quickRestBtn"><i class="bi bi-moon"></i> Отдых</button>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><p id="deleteMessage"></p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Конфигурация и Состояние ---
    const config = { startHour: 0, endHour: 24, slotMinutes: 15, slotHeight: 25 };
    const state = {
        selectedCells: new Set(),
        categories: [],
        events: [],
        templates: [],
        isCtrlPressed: false,
        weekStartDate: new Date() // Дата начала текущей отображаемой недели
    };

    // --- Инициализация ---
    init();

    async function init() {
        console.log('Инициализация приложения...');
        initTimeSelects();
        initSelectionHandlers();
        initEventHandlers();
        
        loadDefaultCategories();
        loadFromLocalStorage(); // Загружаем события и категории
        
        // Устанавливаем текущую неделю
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Понедельник
        state.weekStartDate = new Date(today.setDate(diff));
        state.weekStartDate.setHours(0,0,0,0);
        
        updateWeekView();
        
        // Запуск таймера обновления линии времени
        initCurrentTimeIndicator();
        setInterval(updateCurrentTimeHighlight, 60000);
    }

    // --- Рендеринг Таблицы (Заголовки и Сетка) ---
    function updateWeekView() {
        renderHeader();
        renderGrid();
        renderEvents();
        updateWeekPickerVal();
        updateWeekRangeText();
        updateBalanceWheel();
    }

    function renderHeader() {
        const thead = document.getElementById('scheduleHeader');
        thead.innerHTML = '';
        
        // Строка 1: Время + Даты
        const trDates = document.createElement('tr');
        const thTime = document.createElement('th');
        thTime.className = 'time-column';
        thTime.textContent = 'Время';
        trDates.appendChild(thTime);
        
        const days = ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота', 'Воскресенье'];
        const currentLoopDate = new Date(state.weekStartDate);
        
        for (let i = 0; i < 7; i++) {
            const th = document.createElement('th');
            th.colSpan = 2;
            th.className = 'day-column';
            
            const dateStr = currentLoopDate.getDate().toString().padStart(2,'0') + '.' + 
                            (currentLoopDate.getMonth()+1).toString().padStart(2,'0');
            
            th.innerHTML = `<div class="day-header">${days[i]}<br><small class="day-date">${dateStr}</small></div>`;
            trDates.appendChild(th);
            currentLoopDate.setDate(currentLoopDate.getDate() + 1);
        }
        thead.appendChild(trDates);
        
        // Строка 2: План / Факт
        const trSub = document.createElement('tr');
        trSub.innerHTML = '<th class="time-column"></th>';
        for (let i = 0; i < 7; i++) {
            trSub.innerHTML += '<th class="plan-header">План</th><th class="fact-header">Факт</th>';
        }
        thead.appendChild(trSub);
    }

    function renderGrid() {
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = '';
        
        for (let hour = config.startHour; hour < config.endHour; hour += config.slotMinutes/60) {
            const row = document.createElement('tr');
            row.className = 'time-slot-row';
            
            const hourInt = Math.floor(hour);
            const minutes = Math.round((hour - hourInt) * 60);
            const timeStr = `${hourInt.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
            
            if (minutes === 0) row.classList.add('hour-marker');
            
            // Колонка времени
            const tdTime = document.createElement('td');
            tdTime.className = 'time-column';
            tdTime.textContent = timeStr;
            row.appendChild(tdTime);
            
            // 7 дней * 2 колонки
            for (let day = 0; day < 7; day++) {
                // План
                const tdPlan = document.createElement('td');
                tdPlan.className = 'plan-column';
                tdPlan.dataset.day = day;
                tdPlan.dataset.time = timeStr;
                tdPlan.dataset.type = 'plan';
                tdPlan.dataset.id = `${day}-${timeStr}-plan`;
                row.appendChild(tdPlan);
                
                // Факт
                const tdFact = document.createElement('td');
                tdFact.className = 'fact-column';
                tdFact.dataset.day = day;
                tdFact.dataset.time = timeStr;
                tdFact.dataset.type = 'fact';
                tdFact.dataset.id = `${day}-${timeStr}-fact`;
                row.appendChild(tdFact);
            }
            tbody.appendChild(row);
        }
        updateCurrentTimeHighlight();
    }

    // --- Управление событиями (Клик и Создание) ---
    function initSelectionHandlers() {
        const table = document.getElementById('scheduleTable');
        
        table.addEventListener('click', (e) => {
            // 1. Клик по событию (Редактирование)
            const eventEl = e.target.closest('.plan-event, .fact-event');
            if (eventEl) {
                if (!state.isCtrlPressed) editEvent(eventEl.dataset.id);
                return;
            }
            
            // 2. Клик по ячейке (Создание или Выделение)
            const cell = e.target.closest('.plan-column, .fact-column');
            if (cell) {
                if (state.isCtrlPressed) {
                    toggleSelection(cell);
                } else {
                    clearSelection();
                    createEventFromCell(cell);
                }
            }
        });
        
        document.addEventListener('keydown', (e) => { if(e.key === 'Control' || e.key === 'Meta') state.isCtrlPressed = true; });
        document.addEventListener('keyup', (e) => { if(e.key === 'Control' || e.key === 'Meta') state.isCtrlPressed = false; });
    }

    function createEventFromCell(cell) {
        const dayIdx = parseInt(cell.dataset.day);
        const timeStr = cell.dataset.time;
        const type = cell.dataset.type;
        
        // Вычисляем дату клика
        const clickDate = new Date(state.weekStartDate);
        clickDate.setDate(clickDate.getDate() + dayIdx);
        
        const [hh, mm] = timeStr.split(':').map(Number);
        const start = new Date(clickDate);
        start.setHours(hh, mm, 0, 0);
        
        const end = new Date(start);
        end.setMinutes(end.getMinutes() + 15); // Дефолт 15 мин
        
        showEventModal(type, start, end);
    }

    function showEventModal(type, start, end, eventId = null, desc = '', catId = '') {
        const modalEl = document.getElementById('addEventModal');
        const modal = new bootstrap.Modal(modalEl);
        const form = document.getElementById('addEventForm');
        form.reset();
        
        // Заполняем поля
        document.querySelector(`input[name="eventType"][value="${type}"]`).checked = true;
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('startTime').value = fmtTime(start);
        document.getElementById('endDate').value = end.toISOString().split('T')[0];
        document.getElementById('endTime').value = fmtTime(end);
        document.getElementById('eventDescription').value = desc;
        document.getElementById('categorySelect').value = catId;
        
        // Настройка кнопок (Создать или Сохранить/Удалить)
        const footer = modalEl.querySelector('.modal-footer');
        // Удаляем старую кнопку удаления если есть
        const oldDel = document.getElementById('btnDeleteEvent');
        if (oldDel) oldDel.remove();
        
        const submitBtn = footer.querySelector('button[type="submit"]');
        
        if (eventId) {
            modalEl.querySelector('.modal-title').textContent = 'Редактировать';
            submitBtn.textContent = 'Сохранить';
            modalEl.dataset.editId = eventId;
            
            const delBtn = document.createElement('button');
            delBtn.id = 'btnDeleteEvent';
            delBtn.className = 'btn btn-danger me-auto';
            delBtn.textContent = 'Удалить';
            delBtn.type = 'button';
            delBtn.onclick = () => {
                if(confirm('Удалить?')) {
                    deleteEvent(eventId);
                    modal.hide();
                }
            };
            footer.prepend(delBtn);
        } else {
            modalEl.querySelector('.modal-title').textContent = 'Новое событие';
            submitBtn.textContent = 'Создать';
            delete modalEl.dataset.editId;
        }

        modal.show();
        
        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = {
                id: modalEl.dataset.editId || Date.now().toString(),
                type: document.querySelector('input[name="eventType"]:checked').value,
                categoryId: document.getElementById('categorySelect').value,
                desc: document.getElementById('eventDescription').value,
                start: new Date(document.getElementById('startDate').value + 'T' + document.getElementById('startTime').value),
                end: new Date(document.getElementById('endDate').value + 'T' + document.getElementById('endTime').value)
            };
            
            if(!formData.categoryId) { alert('Выберите категорию'); return; }
            if(formData.end <= formData.start) { alert('Конец должен быть позже начала'); return; }

            saveEvent(formData);
            modal.hide();
        };
    }

    function editEvent(id) {
        const evt = state.events.find(e => e.id === id);
        if(!evt) return;
        showEventModal(evt.type, new Date(evt.start), new Date(evt.end), evt.id, evt.desc, evt.categoryId);
    }

    function saveEvent(data) {
        const idx = state.events.findIndex(e => e.id === data.id);
        if (idx >= 0) state.events[idx] = data;
        else state.events.push(data);
        
        saveToLocalStorage();
        renderEvents();
        updateBalanceWheel();
    }

    function deleteEvent(id) {
        state.events = state.events.filter(e => e.id !== id);
        saveToLocalStorage();
        renderEvents();
        updateBalanceWheel();
    }

    // --- Отрисовка событий на сетке ---
    function renderEvents() {
        // Удаляем старые
        document.querySelectorAll('.plan-event, .fact-event').forEach(e => e.remove());
        
        const weekEnd = new Date(state.weekStartDate);
        weekEnd.setDate(weekEnd.getDate() + 7);

        state.events.forEach(evt => {
            const start = new Date(evt.start);
            const end = new Date(evt.end);
            
            // Проверка попадания в неделю
            if (start < state.weekStartDate || start >= weekEnd) return;

            // Расчет позиции
            const dayIdx = (start.getDay() + 6) % 7; // Пн=0
            const startMins = start.getHours()*60 + start.getMinutes();
            const endMins = end.getHours()*60 + end.getMinutes();
            const durationMins = endMins - startMins;
            
            // Находим строку таблицы
            const rows = document.getElementById('scheduleBody').children;
            // Индекс строки = (минуты с начала дня) / 15
            const rowIdx = Math.floor(startMins / 15);
            
            if (rowIdx >= 0 && rowIdx < rows.length) {
                const row = rows[rowIdx];
                // Индекс ячейки: 0=Time, 1=Day0Plan, 2=Day0Fact, 3=Day1Plan...
                // Offset = 1 + dayIdx*2 + (type=='fact'?1:0)
                const cellIdx = 1 + (dayIdx * 2) + (evt.type === 'fact' ? 1 : 0);
                const cell = row.children[cellIdx];
                
                if (cell) {
                    const div = document.createElement('div');
                    div.className = evt.type === 'plan' ? 'plan-event' : 'fact-event';
                    div.dataset.id = evt.id;
                    
                    const cat = state.categories.find(c => c.id == evt.categoryId);
                    div.textContent = cat ? cat.name : 'Событие';
                    if (cat) div.style.borderLeftColor = cat.color;
                    
                    // Высота: 1 слот = 25px. (минуты / 15) * 25
                    const height = (durationMins / 15) * 25 - 2; // -2 border
                    div.style.height = Math.max(20, height) + 'px';
                    
                    cell.appendChild(div);
                }
            }
        });
    }

    // --- Утилиты и Хелперы ---
    function fmtTime(date) {
        return date.toTimeString().substring(0,5);
    }
    
    function updateWeekPickerVal() {
        // Формат YYYY-Www
        const d = new Date(state.weekStartDate);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
        const week1 = new Date(d.getFullYear(), 0, 4);
        const week = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        
        document.getElementById('weekPicker').value = `${d.getFullYear()}-W${week.toString().padStart(2,'0')}`;
    }

    function updateWeekRangeText() {
        const end = new Date(state.weekStartDate);
        end.setDate(end.getDate() + 6);
        const fmt = d => d.toLocaleDateString('ru-RU');
        document.getElementById('weekRange').textContent = `${fmt(state.weekStartDate)} - ${fmt(end)}`;
    }

    // --- Категории ---
    function loadDefaultCategories() {
        if (!state.categories || state.categories.length === 0) {
            state.categories = [
                { id: '1', name: 'Работа', color: '#f8b5d1' },
                { id: '2', name: 'Учёба', color: '#cdb4db' },
                { id: '3', name: 'Спорт', color: '#a7d2cb' },
                { id: '4', name: 'Отдых', color: '#ffd6e7' }
            ];
        }
        updateCategoryUI();
    }

    function updateCategoryUI() {
        const selects = [document.getElementById('categorySelect'), document.getElementById('bulkCategorySelect'), document.getElementById('quickCategory')];
        selects.forEach(sel => {
            sel.innerHTML = '<option value="">Выбрать...</option>';
            state.categories.forEach(c => {
                sel.innerHTML += `<option value="${c.id}" style="color:${c.color}">${c.name}</option>`;
            });
        });

        const list = document.getElementById('categoriesList');
        list.innerHTML = '';
        state.categories.forEach(c => {
            list.innerHTML += `
                <div class="category-item" style="border-left-color:${c.color}">
                    <div class="category-color" style="background:${c.color}"></div>
                    <div class="flex-grow-1">${c.name}</div>
                    <button class="btn btn-sm text-danger" onclick="deleteCategory('${c.id}')"><i class="bi bi-trash"></i></button>
                </div>`;
        });
        
        // Переопределяем window.deleteCategory для доступа из HTML string
        window.deleteCategory = (id) => {
            if(confirm('Удалить категорию?')) {
                state.categories = state.categories.filter(c => c.id != id);
                state.events = state.events.filter(e => e.categoryId != id);
                saveToLocalStorage();
                updateCategoryUI();
                renderEvents();
            }
        };
    }

    // --- Обработчики Кнопок ---
    function initEventHandlers() {
        document.getElementById('prevWeekBtn').onclick = () => changeWeek(-7);
        document.getElementById('nextWeekBtn').onclick = () => changeWeek(7);
        document.getElementById('currentWeekBtn').onclick = () => {
             const today = new Date();
             const day = today.getDay();
             const diff = today.getDate() - day + (day === 0 ? -6 : 1);
             state.weekStartDate = new Date(today.setDate(diff));
             state.weekStartDate.setHours(0,0,0,0);
             updateWeekView();
        };
        
        document.getElementById('weekPicker').onchange = (e) => {
            const [y, w] = e.target.value.split('-W');
            const simple = new Date(y, 0, 1 + (w - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            state.weekStartDate = ISOweekStart;
            updateWeekView();
        };

        // Модалка категорий
        document.getElementById('addCategoryBtn').onclick = () => {
            const m = new bootstrap.Modal(document.getElementById('categoryModal'));
            initColorPicker();
            m.show();
        };
        document.getElementById('categoryForm').onsubmit = (e) => {
            e.preventDefault();
            state.categories.push({
                id: Date.now().toString(),
                name: document.getElementById('categoryName').value,
                color: document.getElementById('selectedColor').value
            });
            saveToLocalStorage();
            updateCategoryUI();
            bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        };

        // Быстрые кнопки
        const quickMap = {'quickWorkBtn':'Работа', 'quickSportBtn':'Спорт', 'quickStudyBtn':'Учёба', 'quickRestBtn':'Отдых', 'quickBreakfastBtn':'Отдых'};
        Object.keys(quickMap).forEach(id => {
            const btn = document.getElementById(id);
            if(btn) btn.onclick = () => {
                const cat = state.categories.find(c => c.name === quickMap[id]);
                if(!cat) { alert('Категория не найдена'); return; }
                const now = new Date(); // Сейчас
                // Округляем до 15 мин
                const mins = now.getMinutes();
                now.setMinutes(Math.floor(mins/15)*15, 0, 0);
                const end = new Date(now);
                end.setMinutes(now.getMinutes() + 60);
                
                saveEvent({
                    id: Date.now().toString(),
                    type: 'fact',
                    categoryId: cat.id,
                    desc: quickMap[id],
                    start: now,
                    end: end
                });
            };
        });
        
        // Очистка и Копия дня
        document.getElementById('clearDayBtn').onclick = () => {
            if(confirm('Очистить события на сегодня?')) {
                const todayStr = new Date().toDateString();
                state.events = state.events.filter(e => new Date(e.start).toDateString() !== todayStr);
                saveEvent(null); // Триггер сохранения
            }
        };
    }

    function changeWeek(days) {
        state.weekStartDate.setDate(state.weekStartDate.getDate() + days);
        updateWeekView();
    }

    // --- LocalStorage ---
    function saveToLocalStorage() {
        localStorage.setItem('tt_events', JSON.stringify(state.events));
        localStorage.setItem('tt_categories', JSON.stringify(state.categories));
    }
    
    function loadFromLocalStorage() {
        const ev = localStorage.getItem('tt_events');
        const cat = localStorage.getItem('tt_categories');
        if(ev) state.events = JSON.parse(ev);
        if(cat) state.categories = JSON.parse(cat);
    }

    // --- Вспомогательные ---
    function initTimeSelects() {
        const s = document.getElementById('startTime');
        const e = document.getElementById('endTime');
        for(let i=0; i<24*4; i++) {
            const h = Math.floor(i/4).toString().padStart(2,'0');
            const m = ((i%4)*15).toString().padStart(2,'0');
            const v = `${h}:${m}`;
            s.innerHTML += `<option value="${v}">${v}</option>`;
            e.innerHTML += `<option value="${v}">${v}</option>`;
        }
    }
    
    function initColorPicker() {
        const colors = ['#f8b5d1', '#ffafcc', '#cdb4db', '#e2d4f0', '#a7d2cb', '#a2d2ff', '#ffd6e7'];
        const box = document.getElementById('colorPicker');
        box.innerHTML = '';
        colors.forEach(c => {
            const d = document.createElement('div');
            d.style.cssText = `width:30px;height:30px;background:${c};border-radius:50%;cursor:pointer;border:2px solid #fff;box-shadow:0 0 3px #ccc;`;
            d.onclick = () => {
                document.getElementById('selectedColor').value = c;
                Array.from(box.children).forEach(x => x.style.borderColor='#fff');
                d.style.borderColor = '#333';
            };
            box.appendChild(d);
        });
    }

    function initCurrentTimeIndicator() {
        // Подсветка текущего времени
        updateCurrentTimeHighlight();
    }
    
    function updateCurrentTimeHighlight() {
        document.querySelectorAll('.current-time-slot').forEach(e => e.classList.remove('current-time-slot'));
        const now = new Date();
        // Если день вне отображаемой недели - выход
        if(now < state.weekStartDate) return;
        const diff = Math.floor((now - state.weekStartDate)/(1000*60*60*24));
        if(diff > 6) return;

        const dayIdx = (now.getDay() + 6) % 7;
        const mins = now.getHours()*60 + now.getMinutes();
        const rowIdx = Math.floor(mins/15);
        
        const rows = document.getElementById('scheduleBody').children;
        if(rowIdx < rows.length) {
            const row = rows[rowIdx];
            // Подсветка ячеек дня
            const idx1 = 1 + dayIdx*2; 
            if(row.children[idx1]) row.children[idx1].classList.add('current-time-slot');
            if(row.children[idx1+1]) row.children[idx1+1].classList.add('current-time-slot');
        }
    }

    function updateBalanceWheel() {
        // Упрощенная отрисовка колеса (заглушка для примера)
        const ctx = document.getElementById('balanceWheel').getContext('2d');
        ctx.clearRect(0,0,250,250);
        ctx.beginPath();
        ctx.arc(125,125,100,0,Math.PI*2);
        ctx.fillStyle = '#f0f0f0';
        ctx.fill();
        // Тут можно добавить логику отрисовки сегментов на основе state.events
    }

    // --- Массовое выделение (упрощено) ---
    function toggleSelection(cell) {
        if(cell.classList.contains('selected')) {
            cell.classList.remove('selected');
            state.selectedCells.delete(cell.dataset.id);
        } else {
            cell.classList.add('selected');
            state.selectedCells.add(cell.dataset.id);
        }
        updateBulkPanel();
    }
    function clearSelection() {
        document.querySelectorAll('.selected').forEach(c => c.classList.remove('selected'));
        state.selectedCells.clear();
        updateBulkPanel();
    }
    function updateBulkPanel() {
        const p = document.getElementById('bulkEditPanel');
        const cnt = state.selectedCells.size;
        if(cnt > 0) {
            p.classList.add('show');
            document.getElementById('selectedCount').textContent = cnt + ' выбрано';
        } else {
            p.classList.remove('show');
        }
    }
    document.getElementById('bulkCancelBtn').onclick = () => { clearSelection(); };
});
</script>

</body>
</html>
