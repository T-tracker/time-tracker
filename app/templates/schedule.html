{% extends "base.html" %}

{% block title %}Расписание - Time Tracker{% endblock %}

{% block extra_css %}
<style>
    /* Основные стили */
    .main-content {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    .schedule-section {
        flex: 1;
        min-width: 0;
    }
    
    .right-sidebar {
        width: 350px;
        min-width: 350px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    /* Панель управления */
    .schedule-controls {
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(248, 181, 209, 0.05);
        margin-bottom: 1rem;
        border: 1px solid rgba(248, 181, 209, 0.15);
    }
    
    /* Таблица расписания с раздельными колонками */
    .schedule-container {
        background: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
        overflow: hidden;
        overflow-x: auto;
        width: 100%;
        border: 1px solid rgba(248, 181, 209, 0.15);
    }
    
    .schedule-header {
        background: var(--gradient-primary);
        color: var(--text-color);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
    }
    
    .schedule-table {
        min-width: 1200px;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .time-column {
        width: 80px;
        background-color: rgba(248, 181, 209, 0.05);
        font-size: 0.85rem;
        color: #666;
        text-align: center;
        vertical-align: top;
        padding: 0.5rem;
        border-right: 1px solid rgba(248, 181, 209, 0.2);
        position: sticky;
        left: 0;
        z-index: 50;
    }
    
    .day-column {
        width: 100px;
        vertical-align: top;
        border-right: 1px solid rgba(248, 181, 209, 0.2);
        position: relative;
    }
    
    .day-header {
        background-color: rgba(248, 181, 209, 0.1);
        padding: 0.75rem;
        font-weight: 600;
        text-align: center;
        border-bottom: 2px solid rgba(248, 181, 209, 0.3);
        position: sticky;
        top: 60px;
        z-index: 80;
        color: var(--text-color);
    }
    
    .plan-column {
        background-color: rgba(167, 210, 203, 0.05); /* Мятный */
        border-bottom: 1px solid rgba(167, 210, 203, 0.1);
        height: 25px;
        padding: 0;
        position: relative;
        cursor: pointer;
    }
    
    .fact-column {
        background-color: rgba(205, 180, 219, 0.05); /* Лавандовый */
        border-bottom: 1px solid rgba(205, 180, 219, 0.1);
        height: 25px;
        padding: 0;
        position: relative;
        cursor: pointer;
    }
    
    .plan-header {
        background-color: rgba(167, 210, 203, 0.2); /* Мятный 20% */
        color: #2d6a4f; /* Темно-мятный текст */
        padding: 0.4rem;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
        border-bottom: 1px solid rgba(167, 210, 203, 0.3);
        position: sticky;
        top: 105px;
        z-index: 70;
    }
    
    .fact-header {
        background-color: rgba(205, 180, 219, 0.2); /* Лавандовый 20% */
        color: #6d5a8a; /* Темно-лавандовый текст */
        padding: 0.4rem;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
        border-bottom: 1px solid rgba(205, 180, 219, 0.3);
        position: sticky;
        top: 105px;
        z-index: 70;
    }


    
    /* Уменьшенные ячейки */
    .time-slot-row {
        height: 25px;
    }
    
    .plan-event, .fact-event {
        position: absolute;
        left: 1px;
        right: 1px;
        border-radius: 3px;
        padding: 1px 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        border-left: 3px solid;
        z-index: 10;
        line-height: 1.2;
    }
    
    .plan-event {
        background-color: rgba(167, 210, 203, 0.15);
        border-color: #a7d2cb; /* Мятный */
    }
    
    .fact-event {
        background-color: rgba(205, 180, 219, 0.15);
        border-color: #cdb4db; /* Лавандовый */
    }
    
    /* Выделение ячеек */
    .plan-column.selected {
        background-color: rgba(167, 210, 203, 0.25);
        box-shadow: inset 0 0 0 2px #a7d2cb;
    }
    
    .fact-column.selected {
        background-color: rgba(205, 180, 219, 0.25);
        box-shadow: inset 0 0 0 2px #cdb4db;
    }
    
    /* Текущее время */
    .current-time-slot {
        background-color: rgba(255, 209, 102, 0.15); /* Пастельно-желтый */
        position: relative;
    }
    
    .current-time-slot::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 2px;
        background-color: #ffd166; /* Пастельно-желтый */
        z-index: 5;
    }
    
    /* Панель массового заполнения */
    .bulk-edit-panel {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--card-bg);
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(248, 181, 209, 0.15);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 15px;
        border: 1px solid rgba(248, 181, 209, 0.2);
    }
    
    .bulk-edit-panel.show {
        display: flex;
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    
    .selected-count {
        font-weight: 600;
        color: var(--primary-color);
        margin-right: 10px;
    }
    
    /* Категории - правая панель */
    .categories-panel {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
        border: 1px solid rgba(248, 181, 209, 0.15);
    }
    
    .categories-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    
    .category-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        background: rgba(248, 181, 209, 0.05);
        border-left: 4px solid;
        transition: all 0.2s;
    }
    
    .category-item:hover {
        background: rgba(248, 181, 209, 0.1);
        transform: translateX(5px);
    }
    
    .category-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .category-name {
        font-weight: 600;
        margin-bottom: 2px;
        color: var(--text-color);
    }
    
    /* График продуктивности */
    .productivity-chart {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
        border: 1px solid rgba(248, 181, 209, 0.15);
    }
    
    /* Колесо баланса */
    .balance-wheel-container {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
        border: 1px solid rgba(248, 181, 209, 0.15);
        height: 350px;
        display: flex;
        flex-direction: column;
    }
    
    .wheel-canvas {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    }
    
    #balanceWheel {
        max-width: 100%;
        max-height: 100%;
    }
    
    .wheel-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1rem;
        font-size: 0.8rem;
    }
    
    .wheel-legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .wheel-period-selector {
        margin-bottom: 1rem;
        border: 1px solid rgba(248, 181, 209, 0.3);
        background: rgba(248, 181, 209, 0.05);
    }
    
    /* Быстрые действия */
    .quick-actions {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(248, 181, 209, 0.1);
        border: 1px solid rgba(248, 181, 209, 0.15);
    }
    
    .actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 1rem;
    }
    
    .action-btn {
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid rgba(248, 181, 209, 0.3);
        background: rgba(248, 181, 209, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        cursor: pointer;
        text-align: center;
    }
    
    .action-btn:hover {
        background: rgba(248, 181, 209, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(248, 181, 209, 0.2);
        border-color: var(--primary-color);
    }
    
    .action-icon {
        font-size: 1.5rem;
        color: var(--primary-color);
    }
    
    .action-text {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    /* Индикатор времени */
    .current-time-indicator {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #ff9a9e; /* Розово-красный */
        z-index: 20;
        pointer-events: none;
    }
    
    .current-time-indicator::after {
        content: '';
        position: absolute;
        top: -3px;
        left: -5px;
        width: 8px;
        height: 8px;
        background-color: #ff9a9e; /* Розово-красный */
        border-radius: 50%;
    }
    
    /* Баджи в заголовке таблицы */
    .badge.bg-success {
        background: linear-gradient(135deg, #a7d2cb 0%, #b8e1d9 100%) !important;
        color: #2d6a4f;
    }
    
    .badge.bg-primary {
        background: var(--gradient-secondary) !important;
        color: var(--text-color);
    }
    /* Стили для кнопок добавления событий */
    .btn-group .btn-outline-success {
        border-color: #a7d2cb;
        color: #2d6a4f;
    }
    
    .btn-group .btn-outline-success:hover {
        background-color: rgba(167, 210, 203, 0.1);
        border-color: #a7d2cb;
        color: #2d6a4f;
    }
    
    .btn-group .btn-outline-primary {
        border-color: #cdb4db;
        color: #6d5a8a;
    }
    
    .btn-group .btn-outline-primary:hover {
        background-color: rgba(205, 180, 219, 0.1);
        border-color: #cdb4db;
        color: #6d5a8a;
    }
    
    /* Адаптивность */
    @media (max-width: 1200px) {
        .main-content {
            flex-direction: column;
        }
        
        .right-sidebar {
            width: 100%;
            min-width: auto;
        }
        
        .schedule-container {
            min-width: 100%;
        }
    }
    
    @media (max-width: 768px) {
        .schedule-container {
            border-radius: 10px;
        }
        
        .schedule-controls {
            padding: 0.75rem;
        }
        
        .plan-header, .fact-header {
            font-size: 0.8rem;
            padding: 0.3rem;
        }
        
        .plan-column, .fact-column {
            height: 22px;
            min-width: 50px;
            width: 50px;
        }
        
        .bulk-edit-panel {
            flex-wrap: wrap;
            bottom: 10px;
            padding: 0.75rem;
        }
        
        .actions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Панель управления -->
    <div class="schedule-controls">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h4 class="mb-0">Расписание</h4>
                <small class="text-muted">Шаг 15 минут</small>
            </div>
            
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-success" id="addPlanBtn">
                        <i class="bi bi-plus-circle me-1"></i>Добавить план
                    </button>
                    <button class="btn btn-outline-primary" id="addFactBtn">
                        <i class="bi bi-plus-circle me-1"></i>Добавить факт
                    </button>
                </div>
                
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text"><i class="bi bi-calendar-week"></i></span>
                    <input type="week" class="form-control" id="weekPicker">
                    <button class="btn btn-outline-secondary" type="button" id="prevWeekBtn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="nextWeekBtn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="currentWeekBtn">
                        Сегодня
                    </button>
                </div>
                
                <button class="btn btn-outline-success" id="saveTemplateBtn">
                    <i class="bi bi-save me-1"></i>Сохранить как шаблон
                </button>
                
                <button class="btn btn-primary" id="templatesBtn">
                    <i class="bi bi-collection me-1"></i>Шаблоны
                </button>
            </div>
        </div>
    </div>
    
    <!-- Панель массового заполнения -->
    <div class="bulk-edit-panel" id="bulkEditPanel">
        <div class="selected-count" id="selectedCount">0 ячеек выбрано</div>
        <select class="form-select form-select-sm" id="bulkCategorySelect" style="width: 180px;">
            <option value="">Выберите категорию</option>
        </select>
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success" id="bulkPlanBtn">Заполнить как План</button>
            <button class="btn btn-primary" id="bulkFactBtn">Заполнить как Факт</button>
            <button class="btn btn-secondary" id="bulkClearBtn">Очистить</button>
        </div>
        <button class="btn btn-outline-danger btn-sm" id="bulkCancelBtn">Отмена</button>
    </div>
    
    <!-- Основной контент -->
    <div class="main-content">
        <!-- Левая часть: таблица расписания -->
        <div class="schedule-section">
            <div class="schedule-container">
                <div class="schedule-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Недельное расписание</h5>
                            <small id="weekRange"></small>
                        </div>
                        <div class="text-end">
                            <small class="d-block"><span class="badge bg-success">План</span> <span class="badge bg-primary">Факт</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="schedule-table" id="scheduleTable">
                        <thead>
                            <tr>
                                <th class="time-column">Время</th>
                                {% for day in days %}
                                <th colspan="2" class="day-column">
                                    <div class="day-header">
                                        {{ day.name }}<br>
                                        <small class="day-date" data-full-date="{{ day.full_date }}">{{ day.date }}</small>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                            <tr>
                                <th class="time-column"></th>
                                {% for day in days %}
                                <th class="plan-header">План</th>
                                <th class="fact-header">Факт</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <!-- Время будет заполнено JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Правая часть: категории и графики -->
        <div class="right-sidebar">
            <!-- Панель категорий -->
            <div class="categories-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Категории</h5>
                    <button class="btn btn-sm btn-primary" id="addCategoryBtn">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
                <div class="categories-list" id="categoriesList">
                    <!-- Категории будут загружены через JavaScript -->
                </div>
            </div>
            
            <!-- График продуктивности -->
            <div class="productivity-chart">
                <h5>График продуктивности</h5>
                <div class="chart-container" id="productivityChart">
                    <!-- График будет создан JavaScript -->
                </div>
            </div>
            
            <!-- Колесо баланса -->
            <div class="balance-wheel-container">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Колесо баланса</h5>
                    <select class="form-select form-select-sm wheel-period-selector" style="width: 150px;" id="wheelPeriod">
                        <option value="day">Текущий день</option>
                        <option value="week" selected>Текущая неделя</option>
                    </select>
                </div>
                <div class="wheel-canvas">
                    <canvas id="balanceWheel" width="250" height="250"></canvas>
                </div>
                <div class="wheel-legend" id="wheelLegend">
                    <!-- Легенда будет создана JavaScript -->
                </div>
            </div>
            
            <!-- Быстрые действия -->
            <div class="quick-actions">
                <h5>Быстрые действия</h5>
                <div class="actions-grid">
                    <div class="action-btn" id="quickEventBtn">
                        <i class="bi bi-plus-circle action-icon"></i>
                        <span class="action-text">Новое событие</span>
                    </div>
                    <div class="action-btn" id="saveTemplateQuickBtn">
                        <i class="bi bi-save action-icon"></i>
                        <span class="action-text">Сохранить неделю</span>
                    </div>
                    <div class="action-btn" id="applyTemplateQuickBtn">
                        <i class="bi bi-calendar-check action-icon"></i>
                        <span class="action-text">Применить шаблон</span>
                    </div>
                    <div class="action-btn" id="statsBtn">
                        <i class="bi bi-graph-up action-icon"></i>
                        <span class="action-text">Статистика</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
<!-- Модальное окно сохранения шаблона -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Сохранить неделю как шаблон</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="saveTemplateForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Название шаблона</label>
                        <input type="text" class="form-control" id="templateName" required 
                               placeholder="Например: 'Рабочая неделя', 'Учебная неделя'">
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Описание (необязательно)</label>
                        <textarea class="form-control" id="templateDescription" rows="2" 
                                  placeholder="Описание шаблона..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Что сохранить:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="savePlan" checked>
                            <label class="form-check-label" for="savePlan">
                                Запланированные события
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="saveFact" checked>
                            <label class="form-check-label" for="saveFact">
                                Фактические события
                            </label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle"></i> Шаблон сохранит все события текущей недели.
                            Вы сможете применять его к другим неделям.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить шаблон</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Обновленное модальное окно шаблонов -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление шаблонов</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Форма создания нового шаблона -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Создать новый шаблон</h6>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="newTemplateName" 
                                   placeholder="Название нового шаблона">
                            <button class="btn btn-primary" id="createTemplateBtn" type="button">
                                <i class="bi bi-plus-circle me-1"></i>Создать
                            </button>
                        </div>
                        <small class="text-muted">Создаст шаблон из текущего плана недели</small>
                    </div>
                </div>
                
                <!-- Список шаблонов -->
                <h6 class="mb-3">Мои шаблоны</h6>
                <div class="list-group" id="templatesList">
                    <div class="text-center py-4 text-muted" id="noTemplatesMessage">
                        <i class="bi bi-calendar-x display-6 mb-3"></i>
                        <p>Нет сохраненных шаблонов</p>
                        <small>Создайте шаблон, чтобы быстро применять его к другим неделям</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Добавление события -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить событие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEventForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Тип события</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="eventType" id="typePlan" value="plan" checked>
                                <label class="btn btn-outline-success" for="typePlan">План</label>
                                
                                <input type="radio" class="btn-check" name="eventType" id="typeFact" value="fact">
                                <label class="btn btn-outline-primary" for="typeFact">Факт</label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="categorySelect" class="form-label">Категория</label>
                            <select class="form-select" id="categorySelect" required>
                                <option value="">Выберите категорию</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="startDate" class="form-label">Дата начала</label>
                            <input type="date" class="form-control" id="startDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="startTime" class="form-label">Время начала</label>
                            <select class="form-select" id="startTime" required></select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="endDate" class="form-label">Дата окончания</label>
                            <input type="date" class="form-control" id="endDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="endTime" class="form-label">Время окончания</label>
                            <select class="form-select" id="endTime" required></select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Описание (необязательно)</label>
                        <textarea class="form-control" id="eventDescription" rows="2" placeholder="Дополнительные детали..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить событие</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Управление категориями -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новая категория</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Название категории</label>
                        <input type="text" class="form-control" id="categoryName" required placeholder="Например: Работа, Учёба, Спорт...">
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">Цвет категории</label>
                        <div class="d-flex flex-wrap gap-2" id="colorPicker">
                            <!-- Цвета будут добавлены JavaScript -->
                        </div>
                        <input type="hidden" id="selectedColor" value="#4361ee" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Описание (необязательно)</label>
                        <textarea class="form-control" id="categoryDescription" rows="2" placeholder="Описание категории..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать категорию</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Быстрые кнопки для событий -->
<div class="modal fade" id="quickEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новое событие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="quickEventForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quickCategory" class="form-label">Категория</label>
                        <select class="form-select" id="quickCategory" required></select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickType" class="form-label">Тип</label>
                        <select class="form-select" id="quickType">
                            <option value="plan">План</option>
                            <option value="fact">Факт</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickDuration" class="form-label">Длительность</label>
                        <select class="form-select" id="quickDuration">
                            <option value="15">15 минут</option>
                            <option value="30">30 минут</option>
                            <option value="60" selected>1 час</option>
                            <option value="120">2 часа</option>
                            <option value="180">3 часа</option>
                        </select>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="quickToday" checked>
                        <label class="form-check-label" for="quickToday">
                            Добавить на сегодня
                        </label>
                    </div>
                    
                    <!-- Быстрые кнопки -->
                    <div class="quick-add-buttons mt-3">
                        <div class="btn-group btn-group-sm w-100">
                            <button type="button" class="btn btn-outline-success" id="quickBreakfastBtn">
                                <i class="bi bi-cup-hot"></i> Завтрак
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="quickWorkBtn">
                                <i class="bi bi-briefcase"></i> Работа
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="quickSportBtn">
                                <i class="bi bi-heart-pulse"></i> Тренировка
                            </button>
                            <button type="button" class="btn btn-outline-info" id="quickStudyBtn">
                                <i class="bi bi-book"></i> Учёба
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="quickRestBtn">
                                <i class="bi bi-moon"></i> Отдых
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Подтверждение удаления -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Вы уверены, что хотите удалить эту категорию? Все связанные события будут очищены.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Страница расписания загружается...');
    
    // Базовые настройки
    const config = {
        startHour: 0,
        endHour: 24,
        slotMinutes: 15,
        slotHeight: 25
    };

    // Глобальное состояние
    const state = {
        categories: [],
        events: [],
        templates: [],
        selectedCells: new Set()
    };

    // Основные элементы
    const elements = {
        scheduleBody: document.getElementById('scheduleBody'),
        weekPicker: document.getElementById('weekPicker'),
        weekRange: document.getElementById('weekRange'),
        currentWeekBtn: document.getElementById('currentWeekBtn'),
        prevWeekBtn: document.getElementById('prevWeekBtn'),
        nextWeekBtn: document.getElementById('nextWeekBtn'),
        categorySelect: document.getElementById('categorySelect'),
        categoriesList: document.getElementById('categoriesList'),
        addPlanBtn: document.getElementById('addPlanBtn'),
        addFactBtn: document.getElementById('addFactBtn'),
        balanceWheel: document.getElementById('balanceWheel')
    };

    // Проверяем наличие элементов
    console.log('Проверка элементов:', {
        scheduleBody: !!elements.scheduleBody,
        weekPicker: !!elements.weekPicker,
        addPlanBtn: !!elements.addPlanBtn
    });

    // Инициализация
    init();

    async function init() {
        try {
            console.log('Начало инициализации...');
            initSchedule();
            initTimeSelects();
            await loadCategories();
            await loadEvents();
            initEventHandlers();
            initCategoryHandlers()
            updateWeekRange();
            setCurrentWeek();
            console.log('Инициализация завершена');
        } catch (error) {
            console.error('Ошибка инициализации:', error);
        }
    }

    // ==================== ОСНОВНЫЕ ФУНКЦИИ ====================

    function initSchedule() {
        if (!elements.scheduleBody) {
            console.error('scheduleBody не найден!');
            return;
        }
        
        elements.scheduleBody.innerHTML = '';
        
        for (let hour = config.startHour; hour < config.endHour; hour += config.slotMinutes / 60) {
            const hourInt = Math.floor(hour);
            const minute = (hour - hourInt) * 60;
            const timeString = `${hourInt.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            const row = document.createElement('tr');
            row.className = 'time-slot-row';
            
            // Колонка времени
            const timeCell = document.createElement('td');
            timeCell.className = 'time-column';
            timeCell.textContent = timeString;
            row.appendChild(timeCell);
            
            // Колонки для каждого дня
            for (let day = 0; day < 7; day++) {
                const planCell = document.createElement('td');
                planCell.className = 'plan-column';
                planCell.dataset.time = timeString;
                planCell.dataset.day = day;
                planCell.dataset.type = 'plan';
                planCell.dataset.id = `${day}-${timeString}-plan`;
                
                const factCell = document.createElement('td');
                factCell.className = 'fact-column';
                factCell.dataset.time = timeString;
                factCell.dataset.day = day;
                factCell.dataset.type = 'fact';
                factCell.dataset.id = `${day}-${timeString}-fact`;
                
                row.appendChild(planCell);
                row.appendChild(factCell);
            }
            
            elements.scheduleBody.appendChild(row);
        }
        
        console.log('Таблица создана, строк:', elements.scheduleBody.children.length);
    }

    function initTimeSelects() {
        const startTimeSelect = document.getElementById('startTime');
        const endTimeSelect = document.getElementById('endTime');
        
        if (!startTimeSelect || !endTimeSelect) return;
        
        startTimeSelect.innerHTML = '';
        endTimeSelect.innerHTML = '';
        
        for (let hour = 0; hour < 24; hour++) {
            for (let minute = 0; minute < 60; minute += config.slotMinutes) {
                const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                
                const option1 = document.createElement('option');
                option1.value = time;
                option1.textContent = time;
                startTimeSelect.appendChild(option1);
                
                const option2 = option1.cloneNode(true);
                endTimeSelect.appendChild(option2);
            }
        }
    }

    async function loadCategories() {
        try {
            console.log('Загрузка категорий...');
            const response = await fetch('/api/v1/categories');
            
            if (response.ok) {
                const data = await response.json();
                state.categories = data;
                updateCategorySelect();
                console.log('Категорий загружено:', state.categories.length);
            } else {
                console.warn('Ошибка загрузки категорий:', response.status);
                loadDefaultCategories();
            }
        } catch (error) {
            console.error('Ошибка загрузки категорий:', error);
            loadDefaultCategories();
        }
    }

    function loadDefaultCategories() {
        state.categories = [
            { id: 1, name: 'Работа', color: '#f8b5d1' },
            { id: 2, name: 'Учёба', color: '#cdb4db' },
            { id: 3, name: 'Спорт', color: '#a7d2cb' },
            { id: 4, name: 'Отдых', color: '#ffd6e7' }
        ];
        updateCategorySelect();
    }

    function updateCategorySelect() {
        if (!elements.categorySelect) return;
        
        elements.categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
        
        state.categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            option.style.color = category.color;
            elements.categorySelect.appendChild(option);
        });
    }

    async function loadEvents() {
        try {
            const [year, week] = elements.weekPicker.value.split('-W');
            console.log('Загрузка событий для недели:', year, week);
            
            const response = await fetch(`/api/events/week/${year}-W${week.padStart(2, '0')}`);
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    state.events = data.events || [];
                    console.log('Событий загружено:', state.events.length);
                    renderEvents();
                }
            }
        } catch (error) {
            console.error('Ошибка загрузки событий:', error);
        }
    }

    // ==================== СОХРАНЕНИЕ СОБЫТИЙ ====================

    async function saveEvent(eventData) {
        try {
            console.log('Сохранение события:', eventData);
            
            const response = await fetch('/api/events', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(eventData)
            });
            
            const result = await response.json();
            console.log('Ответ сервера:', result);
            
            if (result.success) {
                state.events.push(result.event);
                renderEvents();
                alert('Событие сохранено!');
                return result.event;
            } else {
                alert('Ошибка: ' + result.error);
                return null;
            }
        } catch (error) {
            console.error('Ошибка сохранения:', error);
            alert('Ошибка сети');
            return null;
        }
    }

    function renderEvents() {
        // Очищаем старые события
        document.querySelectorAll('.plan-event, .fact-event').forEach(el => el.remove());
        
        state.events.forEach(event => {
            try {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                
                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;
                const durationSlots = Math.max(1, Math.round((endHour - startHour) * 4));
                const startSlot = Math.round((startHour - config.startHour) * 4);
                
                const dayOfWeek = start.getDay();
                const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const row = elements.scheduleBody.children[startSlot];
                if (!row) return;
                
                const planCellIndex = 1 + adjustedDay * 2;
                const factCellIndex = planCellIndex + 1;
                
                const targetCell = event.type === 'plan' ? 
                    row.children[planCellIndex] : 
                    row.children[factCellIndex];
                
                if (!targetCell) return;
                
                const category = state.categories.find(c => c.id == event.category_id);
                const eventDiv = document.createElement('div');
                eventDiv.className = event.type === 'plan' ? 'plan-event' : 'fact-event';
                eventDiv.textContent = category ? category.name : 'Без категории';
                eventDiv.dataset.eventId = event.id;
                eventDiv.dataset.categoryId = event.category_id;
                
                if (category) {
                    eventDiv.style.borderLeftColor = category.color;
                }
                
                if (durationSlots > 1) {
                    eventDiv.style.height = `${durationSlots * config.slotHeight - 2}px`;
                }
                
                targetCell.appendChild(eventDiv);
                
            } catch (error) {
                console.error('Ошибка рендеринга события:', error);
            }
        });
    }

    // ==================== РАБОТА С НЕДЕЛЯМИ ====================

    function updateWeekRange() {
        if (!elements.weekRange) return;
        
        const [year, week] = elements.weekPicker.value.split('-W');
        const dates = getWeekDates(year, week);
        
        if (dates.start && dates.end) {
            const startStr = formatDate(dates.start);
            const endStr = formatDate(dates.end);
            elements.weekRange.textContent = `${year} - Неделя ${week} (${startStr} - ${endStr})`;
        }
    }

    function getWeekDates(year, week) {
        const simple = new Date(year, 0, 1 + (week - 1) * 7);
        const dow = simple.getDay();
        const start = new Date(simple);
        
        if (dow <= 4) {
            start.setDate(simple.getDate() - simple.getDay() + 1);
        } else {
            start.setDate(simple.getDate() + 8 - simple.getDay());
        }
        
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        
        return { start, end };
    }

    function formatDate(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        return `${day}.${month}`;
    }

    function setCurrentWeek() {
        const today = new Date();
        const year = today.getFullYear();
        const week = getWeekNumber(today);
        if (elements.weekPicker) {
            elements.weekPicker.value = `${year}-W${week.toString().padStart(2, '0')}`;
            updateWeek();
        }
    }

    function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    function prevWeek() {
        const [year, week] = elements.weekPicker.value.split('-W');
        let newWeek = parseInt(week) - 1;
        let newYear = parseInt(year);
        
        if (newWeek < 1) {
            newYear--;
            newWeek = 52;
        }
        
        elements.weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        updateWeek();
    }

    function nextWeek() {
        const [year, week] = elements.weekPicker.value.split('-W');
        let newWeek = parseInt(week) + 1;
        let newYear = parseInt(year);
        
        if (newWeek > 52) {
            newYear++;
            newWeek = 1;
        }
        
        elements.weekPicker.value = `${newYear}-W${newWeek.toString().padStart(2, '0')}`;
        updateWeek();
    }

    function updateWeek() {
        updateWeekRange();
        loadEvents();
    }


        // ==================== КАТЕГОРИИ ====================

    function initCategoryHandlers() {
        console.log('Инициализация обработчиков категорий...');
        
        // Кнопка добавления категории в правой панели
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        if (addCategoryBtn) {
            addCategoryBtn.addEventListener('click', openCategoryModal);
            console.log('Кнопка добавления категории инициализирована');
        }
        
        // Форма создания категории
        const categoryForm = document.getElementById('categoryForm');
        if (categoryForm) {
            categoryForm.addEventListener('submit', handleCategoryForm);
            console.log('Форма категории инициализирована');
        }
        
        // Инициализируем цветовую палитру
        initColorPicker();
    }
    
    function initColorPicker() {
        const colorPicker = document.getElementById('colorPicker');
        if (!colorPicker) return;
        
        const colors = [
            '#f8b5d1', '#cdb4db', '#a7d2cb', '#ffd6e7', '#ffafcc',
            '#bde0fe', '#a2d2ff', '#8ecae6', '#219ebc', '#023047',
            '#ffafcc', '#ff9a9e', '#ffd166', '#06d6a0', '#118ab2'
        ];
        
        colors.forEach(color => {
            const colorDiv = document.createElement('div');
            colorDiv.className = 'color-option';
            colorDiv.style.width = '30px';
            colorDiv.style.height = '30px';
            colorDiv.style.backgroundColor = color;
            colorDiv.style.borderRadius = '50%';
            colorDiv.style.cursor = 'pointer';
            colorDiv.style.border = '2px solid transparent';
            colorDiv.style.display = 'inline-block';
            colorDiv.style.margin = '2px';
            
            colorDiv.addEventListener('click', function() {
                // Убираем выделение у всех цветов
                document.querySelectorAll('.color-option').forEach(el => {
                    el.style.border = '2px solid transparent';
                });
                
                // Выделяем выбранный цвет
                this.style.border = '2px solid var(--primary-color)';
                document.getElementById('selectedColor').value = color;
            });
            
            colorPicker.appendChild(colorDiv);
        });
        
        // Выбираем первый цвет по умолчанию
        if (colorPicker.firstChild) {
            colorPicker.firstChild.click();
        }
    }
    
    function openCategoryModal() {
        console.log('Открытие модального окна категории');
        
        // Сбрасываем форму
        const form = document.getElementById('categoryForm');
        if (form) form.reset();
        
        // Выбираем первый цвет по умолчанию
        const colorPicker = document.getElementById('colorPicker');
        if (colorPicker && colorPicker.firstChild) {
            colorPicker.firstChild.click();
        }
        
        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    }
    
    async function handleCategoryForm(e) {
        e.preventDefault();
        
        const name = document.getElementById('categoryName').value.trim();
        const color = document.getElementById('selectedColor').value;
        
        if (!name) {
            alert('Введите название категории');
            return;
        }
        
        console.log('Создание категории:', { name, color });
        
        try {
            const response = await fetch('/api/v1/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    name: name, 
                    color: color 
                })
            });
            
            const result = await response.json();
            console.log('Ответ сервера:', result);
            
            if (result.success) {
                // Добавляем новую категорию в состояние
                state.categories.push(result.category);
                
                // Обновляем селекторы категорий
                updateCategorySelect();
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
                if (modal) modal.hide();
                
                // Очищаем форму
                e.target.reset();
                
                // Показываем уведомление
                alert(`Категория "${name}" создана!`);
                
                // Перезагружаем события
                await loadEvents();
            } else {
                alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
            }
        } catch (error) {
            console.error('Ошибка создания категории:', error);
            alert('Ошибка сети при создании категории');
        }
    }
    

    // ==================== ОБРАБОТЧИКИ СОБЫТИЙ ====================

    function initEventHandlers() {
        console.log('Инициализация обработчиков событий...');
        
        // Навигация по неделям
        if (elements.currentWeekBtn) {
            elements.currentWeekBtn.addEventListener('click', setCurrentWeek);
        }
        if (elements.prevWeekBtn) {
            elements.prevWeekBtn.addEventListener('click', prevWeek);
        }
        if (elements.nextWeekBtn) {
            elements.nextWeekBtn.addEventListener('click', nextWeek);
        }
        if (elements.weekPicker) {
            elements.weekPicker.addEventListener('change', updateWeek);
        }
        
        // Кнопки добавления событий
        if (elements.addPlanBtn) {
            elements.addPlanBtn.addEventListener('click', () => openAddEventForm('plan'));
        }
        if (elements.addFactBtn) {
            elements.addFactBtn.addEventListener('click', () => openAddEventForm('fact'));
        }
        
        // Клики по ячейкам таблицы
        if (elements.scheduleBody) {
            elements.scheduleBody.addEventListener('click', handleCellClick);
        }
        
        // Форма добавления события
        const addEventForm = document.getElementById('addEventForm');
        if (addEventForm) {
            addEventForm.addEventListener('submit', handleAddEventForm);
        }
        
        // Инициализация обработчиков категорий
        initCategoryHandlers();
        
        console.log('Обработчики инициализированы');
    }

    function handleCellClick(event) {
        const cell = event.target.closest('.plan-column, .fact-column');
        if (!cell) return;
        
        // Если кликнули на событие
        if (event.target.classList.contains('plan-event') || 
            event.target.classList.contains('fact-event')) {
            alert('Редактирование событий в разработке');
            return;
        }
        
        // Создание нового события
        const day = parseInt(cell.dataset.day);
        const time = cell.dataset.time;
        const type = cell.dataset.type;
        
        openAddEventForm(type, {
            day: day,
            time: time
        });
    }

    function openAddEventForm(type = 'plan', presetData = null) {
        // Сбрасываем форму
        const form = document.getElementById('addEventForm');
        if (form) form.reset();
        
        // Устанавливаем тип
        const typeRadio = document.querySelector(`input[name="eventType"][value="${type}"]`);
        if (typeRadio) typeRadio.checked = true;
        
        // Заполняем дату и время если есть presetData
        if (presetData) {
            const weekStart = getWeekStartDate();
            const eventDate = new Date(weekStart);
            eventDate.setDate(weekStart.getDate() + presetData.day);
            
            const dateStr = eventDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = dateStr;
            document.getElementById('endDate').value = dateStr;
            
            const [hours, minutes] = presetData.time.split(':').map(Number);
            const startTime = new Date(eventDate);
            startTime.setHours(hours, minutes, 0, 0);
            
            const endTime = new Date(startTime);
            endTime.setMinutes(endTime.getMinutes() + 15);
            
            const startTimeStr = `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')}`;
            const endTimeStr = `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`;
            
            document.getElementById('startTime').value = startTimeStr;
            document.getElementById('endTime').value = endTimeStr;
        }
        
        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
        modal.show();
    }

    async function handleAddEventForm(e) {
        e.preventDefault();
        
        const eventData = {
            type: document.querySelector('input[name="eventType"]:checked').value,
            category_id: parseInt(document.getElementById('categorySelect').value),
            start_time: `${document.getElementById('startDate').value} ${document.getElementById('startTime').value}:00`,
            end_time: `${document.getElementById('endDate').value} ${document.getElementById('endTime').value}:00`,
            description: document.getElementById('eventDescription').value || ''
        };
        
        if (!eventData.category_id) {
            alert('Выберите категорию');
            return;
        }
        
        const startDate = new Date(eventData.start_time.replace(' ', 'T'));
        const endDate = new Date(eventData.end_time.replace(' ', 'T'));
        
        if (endDate <= startDate) {
            alert('Время окончания должно быть позже времени начала');
            return;
        }
        
        const result = await saveEvent(eventData);
        
        if (result) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
            if (modal) modal.hide();
            e.target.reset();
        }
    }

    function getWeekStartDate() {
        const [year, week] = elements.weekPicker.value.split('-W');
        const dates = getWeekDates(year, week);
        return dates.start;
    }

    // Простой обработчик ошибок
    window.onerror = function(message, source, lineno, colno, error) {
        console.error('Глобальная ошибка:', { message, source, lineno, colno, error });
        return true;
    };
});
</script>
{% endblock %}
